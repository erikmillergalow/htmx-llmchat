package templates

import (
    "strings"
    
    "github.com/pocketbase/pocketbase/tools/types"
)

type ThreadListEntryParams struct {
    Id string `db:"id" json:"id"`
    Title string `db:"thread_title" json:"thread_title"`
    LastMessage string `db:"last_message" json:"last_message"`
    LastMessageTimestamp types.DateTime `db:"last_message_timestamp" json:"last_message_timestamp"`
    Created types.DateTime `db:"created" json:"created"`  
    Tags string `db:"tags" json:"tags"`
    Model string `db:"model" json:"model"`
}

templ ThreadListEntry(params ThreadListEntryParams, isNew bool) {
    <div 
        id={ params.Id }
        class="thread-list-entry"
        hx-get={ "/thread/" + params.Id }
        hx-trigger="click"
        hx-target="#chat-messages"
        if isNew {
            _={ "init set $thread_id to " + "\"" + params.Id + "\"" + " set #thread-title.innerText to " + "\"" + params.Id + "\"" + " set #thread-id-chat.value to " + "\"" + params.Id + "\"" + "remove @disabled from #message-input" }
        } else {
            _={ "on click set $thread_id to " + "\"" + params.Id + "\"" + " set #thread-title.innerText to " + "\"" + params.Id + "\"" + " set #thread-id-chat.value to " + "\"" + params.Id + "\"" + "remove @disabled from #message-input" }
        }
    >
        <h3 class="thread-entry-title">{ params.Title }</h3>
        <p class="thread-entry-model"> { params.Model } </p>
        <p class="thread-entry-message"> { params.LastMessage } </p>
        <div class="dual-timestamps-container">
            <p class="timestamp start">Created at: { types.DateTime.String(params.Created) } </p>
            <p class="timestamp end">Last message: { types.DateTime.String(params.LastMessageTimestamp) } </p>     
        </div>

        <div class="tags-container">
            for _, tag := range strings.Split(params.Tags, "|") {
                <p class="tag"> { tag } </p>
            }
            <p class="tag">tag +</p>
        </div>
    </div> 
}

templ NewThreadListEntry(params ThreadListEntryParams) {
    <div
        id="threads-list"
        hx-swap-oob="afterbegin"
        _={ "init set $thread_id to " + "\"" + params.Id + "\"" + " set #thread-title.innerText to " + "\"" + params.Id + "\"" + " set #thread-id-chat.value to " + "\"" + params.Id + "\"" + "remove @disabled from #message-input" }
    >
        @ThreadListEntry(params, true)
    </div> 
}

templ ThreadListEntries(paramsList []ThreadListEntryParams) {
    for _, params := range paramsList {
        @ThreadListEntry(params, false)
    }
}
