package templates

import (
    "strings"
    
    "github.com/pocketbase/pocketbase/tools/types"
)

type ThreadListEntryParams struct {
    Id string `db:"id" json:"id"`
    Title string `db:"thread_title" json:"thread_title"`
    LastMessage string `db:"last_message" json:"last_message"`
    LastMessageTimestamp types.DateTime `db:"last_message_timestamp" json:"last_message_timestamp"`
    Created types.DateTime `db:"created" json:"created"`  
    Tags string `db:"tags" json:"tags"`
    Model string `db:"model" json:"model"`
}

templ ThreadTitleEditor(id string) {
    <input
        hx-put={ "/thread/title/" + id }
        hx-trigger="blur" 
        hx-target="this"
        hx-swap="outerHTML"
        class="title-edit"
        type="text"
        placeholder="Enter title..."
        name="title"
        autofocus
    ></input>
}

templ ThreadTitle(id string, title string) {
    <div
            hx-trigger="click consume"
            hx-get={ "/thread/title/" + id }
            hx-target="this"
            hx-swap="outerHTML"
    >
        <h3 class="thread-entry-title">
            { title }
        </h3>
    </div>
}

templ OobTextSwap(id string, value string) {
   <div id={ id } hx-swap-oob="innerHTML">Updated at: { value }</div>
}

templ LastMessageTimestamp(id string, time types.DateTime) {
   <div id={ "last-updated-" + id } hx-swap-oob="innerHTML">Updated at: { types.DateTime.String(time) }</div>
}

templ ThreadListEntry(params ThreadListEntryParams, isNew bool) {
    <div 
        id={ params.Id }
        class="thread-list-entry"
        hx-get={ "/thread/" + params.Id }
        hx-trigger="click"
        hx-target="#chat-messages"
        if isNew {
            _={ "init set $thread_id to " + "\"" + params.Id + "\"" + " set #thread-title.innerText to " + "\"" + params.Id + "\"" + " set #thread-id-chat.value to " + "\"" + params.Id + "\"" + "remove @disabled from #message-input" }
        } else {
            _={ "on click set $thread_id to " + "\"" + params.Id + "\"" + " set #thread-title.innerText to " + "\"" + params.Title + "\"" + " set #thread-id-chat.value to " + "\"" + params.Id + "\"" + "remove @disabled from #message-input" }
        }
    >

        @ThreadTitle(params.Id, params.Title)
        <p class="thread-entry-model"> { params.Model } </p>
        <!-- <p class="thread-entry-message"> { params.LastMessage } </p> -->
        <div class="dual-timestamps-container">
            <p class="timestamp start">Created at: { types.DateTime.String(params.Created) } </p>
            <p id={ "last-updated-" + params.Id } class="timestamp end">Updated at: { types.DateTime.String(params.LastMessageTimestamp) } </p>     
        </div>

        <div id="tags" class="tags-container">
            <p class="tag">tag +</p>
            for _, tag := range strings.Split(params.Tags, "|") {
                if (tag != "") {
                    <p class="tag"> { tag } </p>
                }
            }
        </div>
    </div> 
}

templ NewThreadListEntry(params ThreadListEntryParams) {
    <div
        id="threads-list"
        hx-swap-oob="afterbegin"
        _={ "init set $thread_id to " + "\"" + params.Id + "\"" + " set #thread-title.innerText to " + "\"" + params.Id + "\"" + " set #thread-id-chat.value to " + "\"" + params.Id + "\"" + "remove @disabled from #message-input" }
    >
        @ThreadListEntry(params, true)
    </div> 
}

templ ThreadListEntries(paramsList []ThreadListEntryParams) {
    for _, params := range paramsList {
        @ThreadListEntry(params, false)
    }
}
